<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nexus Flow • Search & AI Intelligence</title>

  <!-- ====== Styles ====== -->
  <style>
    :root {
      --bg: #0f1115; --panel: #151923; --muted: #232836; --muted-2: #2b3244; 
      --text: #e6e6e6; --text-dim: #9aa3b6; --accent: #62d0ff; 
      --ok: #30d158; --warn: #ffcc00; --err: #ff453a; 
      --line: #1e2431; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --node: #1a2030; --pipe: #2d3346; --pipe-active: #62d0ff; --pipe-done: #30d158;
      --highlight: #ff9f1c;
    }
    [data-theme="light"] {
      --bg: #f0f2f5; --panel: #ffffff; --muted: #dce3eb; --muted-2: #eef2f6;
      --text: #1a202c; --text-dim: #64748b; --accent: #2563eb;
      --ok: #059669; --warn: #d97706; --err: #dc2626;
      --line: #e2e8f0; --shadow: 0 4px 12px rgba(0,0,0,.05);
      --node: #ffffff; --pipe: #cbd5e1; --pipe-active: #2563eb; --pipe-done: #059669;
      --highlight: #d97706;
    }

    * { box-sizing: border-box; }
    
    body { 
      margin: 0; background: var(--bg); color: var(--text); 
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
      min-height: 100vh; 
      display: flex; flex-direction: column;
      overflow-y: auto; 
      overflow-x: hidden;
    }
    
    header { 
      height: 56px; background: var(--panel); border-bottom: 1px solid var(--line); 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 0 20px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); 
    }
    h1 { font-size: 16px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
    .badge { background: var(--accent); color: #000; font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
    
    main { 
      flex: 1; 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); 
      gap: 30px; 
      padding: 30px; 
      max-width: 1800px;
      margin: 0 auto;
      width: 100%;
      position: relative; 
      padding-bottom: 250px; 
    }
    
    .col { display: flex; flex-direction: column; gap: 20px; min-height: 0; z-index: 2; }
    
    .card { background: var(--panel); border: 1px solid var(--muted); border-radius: 12px; padding: 0; box-shadow: var(--shadow); display: flex; flex-direction: column; position: relative; transition: border-color 0.3s; overflow: hidden; }
    .card:hover { border-color: var(--muted-2); }
    
    .card-head { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--line); padding: 12px 16px; background: var(--muted-2); z-index: 5; }
    .card-title { font-weight: 600; font-size: 14px; color: var(--accent); }
    
    .card-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; transition: opacity 0.3s; }
    
    .card.disabled .card-body { opacity: 0.3; pointer-events: none; filter: grayscale(0.8); }
    .card.disabled .card-head { opacity: 1; pointer-events: auto; }
    
    label { font-size: 12px; font-weight: 600; color: var(--text-dim); display: block; margin-bottom: 4px; }
    input, select, textarea { width: 100%; background: var(--bg); border: 1px solid var(--muted); color: var(--text); padding: 10px; border-radius: 6px; font-family: inherit; font-size: 13px; outline: none; transition: 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 80px; font-family: monospace; line-height: 1.4; }
    
    .btn-row { display: flex; gap: 8px; margin-top: 4px; }
    button { flex: 1; background: var(--muted-2); border: 1px solid var(--muted); color: var(--text); padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: 0.2s; }
    button:hover { border-color: var(--accent); color: var(--accent); }
    button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    button.primary { background: var(--accent); color: #090b10; border: none; }
    button.primary:hover { filter: brightness(1.1); color: #000; }
    
    /* SVG Pipes Layer */
    .pipes-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    .flow-line { fill: none; stroke: var(--pipe); stroke-width: 3px; transition: stroke 0.5s, stroke-dashoffset 1s; }
    .flow-line.active { stroke: var(--pipe-active); filter: drop-shadow(0 0 4px var(--pipe-active)); }
    .flow-line.done { stroke: var(--pipe-done); filter: drop-shadow(0 0 4px var(--pipe-done)); }

    .progress-wrap { height: 4px; background: var(--muted); border-radius: 2px; overflow: hidden; margin-top: 5px; }
    .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
    .status { font-size: 11px; color: var(--text-dim); margin-top: 4px; display: flex; justify-content: space-between; }
    
    /* Scrollable Output Boxes */
    .preview-box { 
        background: var(--bg); 
        border: 1px solid var(--muted); 
        border-radius: 6px; 
        padding: 10px; 
        overflow-y: auto; /* Scrollable */
        font-family: monospace; 
        font-size: 11px; 
        white-space: pre-wrap; 
        scrollbar-width: thin;
        scrollbar-color: var(--accent) var(--bg);
    }

    /* Result Items Styling */
    .result-item { border-bottom: 1px solid var(--line); padding: 10px 0; }
    .result-item:last-child { border-bottom: none; }
    .result-link { color: var(--accent); text-decoration: none; font-weight: bold; display: block; margin-bottom: 4px; word-break: break-all; }
    .result-meta { color: var(--ok); font-size: 10px; margin-bottom: 4px; }
    .result-snippet { color: var(--text-dim); font-size: 12px; line-height: 1.4; }

    /* Logs Drawer */
    #logs { position: fixed; bottom: 0; left: 0; right: 0; height: 200px; background: var(--panel); border-top: 1px solid var(--line); z-index: 200; display: flex; flex-direction: column; transition: transform 0.3s; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
    #logs.minimized { transform: translateY(165px); }
    .log-head { padding: 8px 20px; background: var(--muted-2); font-size: 12px; font-weight: 700; display: flex; justify-content: space-between; cursor: pointer; }
    .log-body { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: var(--text-dim); }
    .log-entry { margin-bottom: 4px; border-bottom: 1px solid var(--line); padding-bottom: 2px; word-break: break-all; }
    .log-entry.ERR { color: var(--err); }
    .log-entry.SUCCESS { color: var(--ok); }
    .log-entry.WARN { color: var(--warn); }
    .log-entry.INFO { color: var(--accent); }

    .switch { position: relative; width: 36px; height: 20px; background: var(--muted); border-radius: 20px; cursor: pointer; transition: 0.3s; }
    .switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.3s; }
    .switch.on { background: var(--accent); }
    .switch.on::after { transform: translateX(16px); }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<header>
  <h1><span>Nexus Flow</span> <span class="badge">Gateway & AI</span></h1>
  <div style="display:flex; gap:15px; align-items:center;">
    <div style="font-size:12px; color:var(--text-dim)">Dark Mode</div>
    <div id="themeToggle" class="switch on"></div>
  </div>
</header>

<main>
  <!-- Visual Pipes SVG -->
  <svg class="pipes-layer" id="flowSvg"></svg>

  <!-- COLUMN 1: SEARCH GATEWAY -->
  <div class="col">
    <div class="card" id="cardStep1">
      <div class="card-head">
        <span class="card-title">1. Search Gateway</span>
        <span class="badge">DuckDuckGo</span>
      </div>
      
      <div class="card-body">
        <div>
            <label>Search Query</label>
            <input type="text" id="searchQuery" placeholder="e.g. latest typescript features">
        </div>
        
        <div class="btn-row">
            <div style="flex:1">
                <label>Source Mode</label>
                <select id="searchMode">
                    <option value="html">HTML Scraping (Deep)</option>
                    <option value="json">API JSON (Fast)</option>
                </select>
            </div>
            <div style="flex:1">
                <label>Max RPM</label>
                <input type="number" id="rpmLimit" value="5" min="1">
            </div>
        </div>

        <button id="btnSearch" class="primary">Initialize Search</button>

        <div>
          <div class="status">
            <span id="status1">Ready</span>
            <span id="reqCount">0 reqs</span>
          </div>
          <div class="progress-wrap"><div id="progBar1" class="progress-bar"></div></div>
        </div>
      </div>
    </div>

    <!-- Raw Data Preview (Optional) -->
    <div class="card" style="flex:1">
      <div class="card-head">
        <span class="card-title">Raw Response</span>
        <button style="width:auto; padding:2px 8px; font-size:10px" onclick="toggleRaw()">Toggle</button>
      </div>
      <div class="card-body" style="flex:1; overflow:hidden;">
        <div id="rawOutput" class="preview-box" style="height:200px; display:none;">// Raw data hidden...</div>
      </div>
    </div>
  </div>

  <!-- COLUMN 2: PROCESSOR & CLEANER -->
  <div class="col">
    <div class="card" id="cardStep2">
      <div class="card-head">
        <span class="card-title">2. Intelligence Processor</span>
        <span class="badge">URL Cleaner</span>
      </div>

      <div class="card-body">
        <div class="btn-row">
            <div style="flex:1">
                <label>Filter Logic</label>
                <div style="font-size:11px; color:var(--text-dim); background:var(--bg); padding:5px; border-radius:4px;">
                    Auto-strips <code>&rut=</code> and decodes <code>uddg=</code> redirects.
                </div>
            </div>
        </div>
        
        <div style="margin-top:10px;">
            <label>Processed Results</label>
            <!-- SCROLLABLE OUTPUT -->
            <div id="processedOutput" class="preview-box" style="height:500px">
                <div style="text-align:center; padding:20px; color:var(--text-dim)">Waiting for search data...</div>
            </div>
        </div>

        <div class="btn-row">
            <button onclick="copyToClip('processedOutput')">Copy Results</button>
            <button onclick="downloadResults()">Download JSON</button>
        </div>
      </div>
    </div>
  </div>

  <!-- COLUMN 3: GROQ AI ANALYST -->
  <div class="col">
    <div class="card" id="cardStep3">
      <div class="card-head">
        <span class="card-title">3. Groq AI Analyst</span>
        <span class="badge">LLM Reasoning</span>
      </div>

      <div class="card-body">
        <div class="btn-row">
          <div style="flex:1">
            <label>Groq API Key</label>
            <input id="groqKey" type="password" placeholder="gsk_...">
          </div>
        </div>

        <div class="btn-row">
          <div style="flex:1">
            <label>Model</label>
            <select id="groqModel">
              <option value="openai/gpt-oss-120b">gpt-oss-120b</option>
              <option value="llama-3.1-8b-instant" selected>llama-3.1-8b-instant</option>
              <option value="llama-3.3-70b-versatile">llama-3.3-70b-versatile</option>
              <option value="mixtral-8x7b-32768">mixtral-8x7b-32768</option>
              <option value="gemma2-9b-it">gemma2-9b-it</option>
            </select>
          </div>
          <div style="flex:1">
             <label>CORS Proxy</label>
             <div style="display:flex; align-items:center; height:36px;">
               <div id="corsToggle" class="switch on" title="Use corsproxy.io"></div>
               <span style="font-size:11px; margin-left:8px">On</span>
             </div>
          </div>
        </div>

        <div>
          <label>Prompt Instruction</label>
          <textarea id="groqPrompt" style="height:100px">Summarize the search results provided in the context. Focus on technical details and provide a concise list of key takeaways.</textarea>
        </div>

        <button id="btnGroq" class="primary" disabled>Run Analysis</button>

        <div>
          <div class="status"><span id="status3">Idle</span></div>
          <div class="progress-wrap"><div id="progBar3" class="progress-bar"></div></div>
        </div>
      </div>
    </div>

    <!-- Groq Output -->
    <div class="card" style="flex:1">
      <div class="card-head">
        <span class="card-title">AI Output</span>
        <button style="width:auto; padding:2px 8px; font-size:10px" onclick="copyToClip('groqOutput')">Copy</button>
      </div>
      <div class="card-body" style="flex:1; overflow:hidden;">
        <!-- SCROLLABLE OUTPUT -->
        <div id="groqOutput" class="preview-box" style="height:400px"></div>
      </div>
    </div>
  </div>
</main>

<!-- Logs Drawer -->
<div id="logs" class="minimized">
  <div class="log-head" onclick="document.getElementById('logs').classList.toggle('minimized')">
    <span>System Logs</span>
    <span>▲ Toggle</span>
  </div>
  <div id="logBody" class="log-body"></div>
</div>

<script>
/**
 * APP STATE
 */
const state = {
    searchResults: [],
    rpmCount: 0,
    rpmStart: Date.now(),
    step1Done: false,
    step2Done: false,
    step3Done: false
};

const ui = {
    searchQuery: document.getElementById('searchQuery'),
    searchMode: document.getElementById('searchMode'),
    rpmLimit: document.getElementById('rpmLimit'),
    btnSearch: document.getElementById('btnSearch'),
    rawOutput: document.getElementById('rawOutput'),
    processedOutput: document.getElementById('processedOutput'),
    
    groqKey: document.getElementById('groqKey'),
    groqModel: document.getElementById('groqModel'),
    groqPrompt: document.getElementById('groqPrompt'),
    btnGroq: document.getElementById('btnGroq'),
    groqOutput: document.getElementById('groqOutput'),
    
    logs: document.getElementById('logBody'),
    flowSvg: document.getElementById('flowSvg')
};

/**
 * INITIALIZATION
 */
(function init() {
    // Theme
    const theme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('themeToggle').classList.toggle('on', theme === 'dark');
    document.getElementById('themeToggle').addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        document.getElementById('themeToggle').classList.toggle('on', !isDark);
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    });

    // Load Keys
    ui.groqKey.value = localStorage.getItem('groqKey') || '';
    ui.groqKey.addEventListener('change', e => localStorage.setItem('groqKey', e.target.value));

    // Toggles
    document.querySelectorAll('.switch').forEach(el => {
        if(el.id !== 'themeToggle') el.addEventListener('click', () => el.classList.toggle('on'));
    });

    // Resize Listener for Pipes
    window.addEventListener('resize', drawFlow);
    setTimeout(drawFlow, 500);

    // Enter Key
    ui.searchQuery.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') runSearch();
    });

    log("Nexus Flow Initialized.", "INFO");
})();

/**
 * LOGGING & UTILS
 */
function log(msg, type="INFO") {
    const div = document.createElement('div');
    div.className = `log-entry ${type}`;
    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    ui.logs.appendChild(div);
    ui.logs.scrollTop = ui.logs.scrollHeight;
}

function setProgress(step, pct, text) {
    const bar = document.getElementById(`progBar${step}`);
    const stat = document.getElementById(`status${step}`);
    if(bar) bar.style.width = `${pct}%`;
    if(stat && text) stat.textContent = text;
}

function toggleRaw() {
    const el = ui.rawOutput;
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

window.copyToClip = (id) => {
    const txt = document.getElementById(id).innerText;
    navigator.clipboard.writeText(txt);
    log("Copied to clipboard", "INFO");
};

/**
 * FLOW VISUALIZATION
 */
function drawFlow() {
    const svg = ui.flowSvg;
    svg.innerHTML = '';
    
    const c1 = document.getElementById('cardStep1').getBoundingClientRect();
    const c2 = document.getElementById('cardStep2').getBoundingClientRect();
    const c3 = document.getElementById('cardStep3').getBoundingClientRect();
    const main = document.querySelector('main').getBoundingClientRect();
    
    const getPos = (rect, side) => ({
        x: side === 'left' ? rect.left - main.left : rect.right - main.left,
        y: rect.top - main.top + (rect.height / 2)
    });

    const createPath = (start, end, status) => {
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const d = `M ${start.x} ${start.y} C ${start.x + 50} ${start.y}, ${end.x - 50} ${end.y}, ${end.x} ${end.y}`;
        path.setAttribute("d", d);
        path.setAttribute("class", `flow-line ${status}`);
        svg.appendChild(path);
    };

    // 1 -> 2
    createPath(getPos(c1, 'right'), getPos(c2, 'left'), state.step1Done ? 'done' : 'active');
    // 2 -> 3
    createPath(getPos(c2, 'right'), getPos(c3, 'left'), state.step2Done ? 'done' : 'active');
}

/**
 * MODULE 1: SEARCH GATEWAY
 */
ui.btnSearch.addEventListener('click', runSearch);

async function runSearch() {
    const query = ui.searchQuery.value.trim();
    const mode = ui.searchMode.value;
    const rpm = parseInt(ui.rpmLimit.value);

    if(!query) return alert("Enter a query");

    // Rate Limit Check
    const now = Date.now();
    if(now - state.rpmStart > 60000) {
        state.rpmCount = 0;
        state.rpmStart = now;
    }
    if(state.rpmCount >= rpm) {
        log("Rate Limit Exceeded. Wait...", "WARN");
        return;
    }
    state.rpmCount++;
    document.getElementById('reqCount').textContent = `${state.rpmCount}/${rpm} RPM`;

    // Reset Flow for new search
    state.step1Done = false;
    state.step2Done = false;
    state.step3Done = false;
    ui.btnGroq.disabled = true;
    drawFlow();

    ui.btnSearch.disabled = true;
    setProgress(1, 20, "Fetching...");
    log(`Searching: ${query} (${mode})`, "INFO");

    try {
        const timestamp = Date.now();
        let targetUrl = '';
        
        if (mode === 'html') {
            targetUrl = `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}&t=${timestamp}`;
        } else {
            targetUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&t=${timestamp}`;
        }

        // Proxy Rotation
        const proxies = [
            `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
            `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`
        ];

        let responseText = null;
        for (const proxy of proxies) {
            try {
                const res = await fetch(proxy);
                if(res.ok) {
                    responseText = await res.text();
                    break;
                }
            } catch(e) { console.warn("Proxy failed", e); }
        }

        if(!responseText) throw new Error("All proxies failed");

        ui.rawOutput.textContent = responseText.substring(0, 2000) + "... (truncated)";
        setProgress(1, 100, "Done");
        state.step1Done = true;
        
        // Trigger Step 2
        processResults(responseText, mode, query);

    } catch(e) {
        log("Search Error: " + e.message, "ERR");
        setProgress(1, 0, "Failed");
    } finally {
        ui.btnSearch.disabled = false;
    }
}

/**
 * MODULE 2: PROCESSOR & CLEANER
 */
function processResults(raw, mode, query) {
    log("Processing & Cleaning URLs...", "INFO");
    let results = [];

    if (mode === 'html') {
        const parser = new DOMParser();
        const doc = parser.parseFromString(raw, 'text/html');
        
        // Heuristic Parsing
        const nodes = doc.querySelectorAll('.result');
        if(nodes.length > 0) {
            nodes.forEach(node => {
                const titleEl = node.querySelector('.result__a');
                const snippetEl = node.querySelector('.result__snippet');
                if(titleEl) {
                    results.push({
                        title: titleEl.innerText.trim(),
                        url: titleEl.getAttribute('href'),
                        snippet: snippetEl ? snippetEl.innerText.trim() : ''
                    });
                }
            });
        } else {
            // Fallback for structure changes
            doc.querySelectorAll('a').forEach(a => {
                const href = a.getAttribute('href');
                if(href && !href.includes('duckduckgo.com') && !href.startsWith('/')) {
                    results.push({
                        title: a.innerText.trim(),
                        url: href,
                        snippet: "Extracted Link"
                    });
                }
            });
        }
    } else {
        // JSON Mode
        try {
            const json = JSON.parse(raw);
            if(json.AbstractText) {
                results.push({ title: json.Heading, url: json.AbstractURL, snippet: json.AbstractText });
            }
            if(json.RelatedTopics) {
                json.RelatedTopics.forEach(t => {
                    if(t.Text && t.FirstURL) {
                        results.push({ title: t.Text.split(' - ')[0], url: t.FirstURL, snippet: t.Text });
                    }
                });
            }
        } catch(e) { log("JSON Parse Error", "ERR"); }
    }

    // CLEANING LOGIC (The "Module Step")
    state.searchResults = results.map(r => {
        let cleanUrl = r.url;
        
        // 1. Decode DDG Redirects (uddg=...)
        if(cleanUrl.includes('uddg=')) {
            try {
                const urlObj = new URL(cleanUrl, 'https://duckduckgo.com');
                const uddg = urlObj.searchParams.get('uddg');
                if(uddg) cleanUrl = decodeURIComponent(uddg);
            } catch(e) {}
        }

        // 2. Strip Tracking Params (&rut=...)
        // Remove &rut=... until the end of string or next &
        cleanUrl = cleanUrl.replace(/&rut=[^&]*/, '');
        
        return { ...r, url: cleanUrl };
    });

    renderProcessed();
    state.step2Done = true;
    ui.btnGroq.disabled = false;
    drawFlow();
    log(`Processed ${state.searchResults.length} results.`, "SUCCESS");
}

function renderProcessed() {
    const container = ui.processedOutput;
    container.innerHTML = '';
    
    if(state.searchResults.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center">No results found.</div>';
        return;
    }

    state.searchResults.forEach(item => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
            <div class="result-meta">${escapeHtml(new URL(item.url).hostname)}</div>
            <a href="${item.url}" target="_blank" class="result-link">${escapeHtml(item.title)}</a>
            <div class="result-snippet">${escapeHtml(item.snippet)}</div>
        `;
        container.appendChild(div);
    });
}

function downloadResults() {
    if(state.searchResults.length === 0) return;
    const blob = new Blob([JSON.stringify(state.searchResults, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'nexus_search_results.json';
    a.click();
}

/**
 * MODULE 3: GROQ AI
 */
ui.btnGroq.addEventListener('click', async () => {
    const key = ui.groqKey.value;
    if(!key) return alert("API Key Required");
    
    ui.btnGroq.disabled = true;
    setProgress(3, 10, "Preparing Context...");
    
    const model = ui.groqModel.value;
    const prompt = ui.groqPrompt.value;
    const useProxy = document.getElementById('corsToggle').classList.contains('on');

    // Prepare Context from Search Results
    const context = state.searchResults.slice(0, 10).map(r => 
        `Title: ${r.title}\nURL: ${r.url}\nSnippet: ${r.snippet}`
    ).join("\n\n");

    const messages = [
        { role: "system", content: "You are an intelligent analyst. Use the provided search results to answer the user's request." },
        { role: "user", content: `SEARCH RESULTS CONTEXT:\n${context}` },
        { role: "user", content: `USER INSTRUCTION:\n${prompt}` }
    ];

    try {
        log("Sending to Groq...", "INFO");
        setProgress(3, 40, "Thinking...");

        let url = "https://api.groq.com/openai/v1/chat/completions";
        if(useProxy) url = "https://corsproxy.io/?" + encodeURIComponent(url);

        const res = await fetch(url, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${key}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: model,
                messages: messages,
                temperature: 0.7,
                max_tokens: 2048
            })
        });

        if(!res.ok) throw new Error(`Groq API: ${res.status}`);
        
        const data = await res.json();
        const content = data.choices[0].message.content;

        ui.groqOutput.textContent = content;
        
        setProgress(3, 100, "Analysis Complete");
        log("Groq Analysis Finished", "SUCCESS");
        state.step3Done = true;
        drawFlow();

    } catch(e) {
        log(e.message, "ERR");
        setProgress(3, 0, "Failed");
        ui.groqOutput.textContent = "Error: " + e.message;
    } finally {
        ui.btnGroq.disabled = false;
    }
});

function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

</script>
</body>
</html>
